# ComfyUI Character Labeler 人物图片标签生成节点

一个强大的ComfyUI自定义节点，用于自动为人物图片生成详细标签和描述。支持CLIP视觉分析、可配置的变量选择和多种输出格式。

## 🎯 功能特性

### 核心功能
- **CLIP视觉分析**: 利用CLIP模型分析图片内容
- **变量选择系统**: 提供核心变量和可变变量的选择
- **智能标签生成**: 自动生成结构化的人物标签
- **多种输出格式**: 支持标签列表、详细描述、JSON格式和提示词格式

### 变量分类

#### 核心（不变）变量
这些是人物相对固定的特征：
- **外观细节**: 发型、发色、瞳色、肤色、体型、年龄范围
- **基本特征**: 性别、种族、物种

#### 可变变量
这些是可能变化的特征：
- **状态与动作**: 表情、姿势、动作
- **环境与场景**: 背景地点、时间、光照条件
- **风格与材质**: 绘画风格、材质表现
- **其他**: 天气、季节、视角、焦点

## 📦 安装方法

### 方式一：直接安装
1. 将 `ComfyUI-Character-Labeler` 文件夹复制到 `ComfyUI/custom_nodes/` 目录下
2. 重启ComfyUI

### 方式二：Git安装
```bash
# 进入ComfyUI自定义节点目录
cd ComfyUI/custom_nodes

# 克隆仓库
git clone https://github.com/yourusername/ComfyUI-Character-Labeler.git

# 进入目录
cd ComfyUI-Character-Labeler
```

### 方式三：管理器安装（如果支持）
如果您使用ComfyUI Manager，可以在管理器中搜索"Character Labeler"安装。

## 📋 依赖安装

如果遇到依赖问题，请手动安装：

```bash
pip install numpy pillow torch torchvision
```

## 🚀 快速开始

### 基本工作流
```
[Load Image] → [CLIP视觉模型加载器] → [CLIP视觉编码器] → [CLIP图像分析器]
                                                                        ↓
[核心变量选择器] → [人物标签生成器]
                 ↑
[可变变量选择器] → [人物标签生成器]
```

### 节点详解

#### 1. 🔤 CLIP相关节点
- **CLIP视觉模型加载器**: 加载CLIP视觉模型
- **CLIP视觉编码器**: 将图像编码为CLIP特征
- **CLIP图像分析器**: 分析图像内容并输出特征

#### 2. 🎯 变量选择器节点
- **核心变量选择器**: 选择人物核心特征（发型、发色、性别等）
- **可变变量选择器**: 选择状态、环境、风格等可变特征

#### 3. ✨ 主节点
- **人物标签生成器**: 整合所有输入生成最终标签

#### 4. ⚙️ 配置管理节点
- **配置管理器**: 管理配置文件（重新加载、导出、重置）

## 📁 配置文件

节点使用JSON配置文件管理变量选项：

- `configs/core_variables.json`: 核心变量配置
- `configs/variable_variables.json`: 可变变量配置

首次运行时会自动创建默认配置文件，您可以直接编辑这些文件来添加或修改变量选项。

## 🔧 配置自定义

### 添加新变量选项
编辑对应的JSON配置文件，按照现有格式添加新的选项：

```json
{
  "appearance": {
    "hair_style": ["长发", "短发", "卷发", "直发", "马尾", "双马尾", "丸子头", "新发型"],
    ...
  }
}
```

### 使用配置管理器
使用 `配置管理器` 节点可以方便地：
- 重新加载配置文件
- 导出当前配置
- 重置为默认配置
- 查看配置详情

## 🎨 输出示例

### 标签列表格式
```
长发, 黑色头发, 蓝色眼睛, 白皙肤色, 女性, 微笑, 正面站立, 城市背景, 白天, 动漫风格
```

### 详细描述格式
```
人物特征: 长发, 黑色头发, 蓝色眼睛, 白皙肤色, 女性。
状态环境: 微笑, 正面站立, 城市背景, 白天。
AI分析: 长发(0.85), 微笑(0.78), 城市背景(0.72)。
```

### JSON格式
```json
{
  "core_variables": {
    "appearance": {
      "hair_style": "长发",
      "hair_color": "黑色",
      "eye_color": "蓝色"
    }
  },
  "variable_variables": {
    "state_action": {
      "expression": {
        "一级": "微笑",
        "二级": ""
      }
    }
  }
}
```

### 提示词格式
```
1girl, long hair, black hair, blue eyes, fair skin, smiling, standing, city background, daytime, anime style
```

## 🛠️ 高级用法

### 使用自定义CLIP模型
1. 将CLIP视觉模型放在 `ComfyUI/models/clip_vision/` 目录下
2. 在 `CLIP视觉模型加载器` 中选择您的模型

### 批量处理
可以将多个图片连接到同一个工作流中，批量生成标签。

### 与其他节点结合
- 与 **文本编码器** 结合：将生成的标签输入到文本编码器中
- 与 **图像生成器** 结合：使用生成的标签作为提示词生成新图像
- 与 **工作流管理器** 结合：自动化标签生成流程

## ⚠️ 常见问题

### 1. 节点不显示
- 确保节点安装在正确的目录下
- 重启ComfyUI
- 检查控制台是否有错误信息

### 2. CLIP分析不工作
- 确保已下载CLIP视觉模型
- 检查模型文件路径
- 确保有足够的GPU内存

### 3. 变量选择器选项为空
- 检查配置文件是否存在
- 确保配置文件格式正确
- 使用配置管理器重新加载配置

### 4. 内存不足
- 减少同时处理的图片数量
- 使用更小的CLIP模型
- 关闭其他消耗内存的节点

## 📊 性能优化

1. **CLIP分析模式选择**：
   - 使用"快速分析"模式处理大量图片
   - 使用"详细分析"模式获取更准确的结果

2. **标签生成优化**：
   - 调整置信度阈值以过滤低质量标签
   - 根据需要选择输出格式
   - 使用"提示词格式"可直接用于AI绘画

## 🔄 更新日志

### v1.0.0
- 初始版本发布
- 支持CLIP视觉分析
- 支持核心变量和可变变量选择
- 支持多种输出格式
- 自动配置文件管理

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📧 联系

如有问题或建议，请在GitHub仓库提交Issue。